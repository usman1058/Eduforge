generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

//// ENUMS ////////////////////////////////////////////////////////

enum UserRole {
  STUDENT
  ADMIN
}

enum RequestStatus {
  CREATED
  PAYMENT_SUBMITTED
  PAYMENT_APPROVED
  PAYMENT_REJECTED
  IN_PROGRESS
  DELIVERED
  CLOSED
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  UNDER_REVIEW
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}
enum ContactStatus {
  PENDING
  RESPONDED
  ARCHIVED
}

enum NotificationType {
  PAYMENT_APPROVED
  PAYMENT_REJECTED
  REQUEST_DELIVERED
  REQUEST_UPDATED
  TICKET_CREATED
  TICKET_UPDATED
  SYSTEM_ANNOUNCEMENT
}

//// USER /////////////////////////////////////////////////////////

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  name                String?
  password            String
  role                UserRole @default(STUDENT)
  phone               String?
  bio                 String?
  address             String?
  avatar              String?
  isSuspended         Boolean  @default(false)
  suspendedAt         DateTime?
  suspendedReason     String?
  resetToken          String?  @unique
  resetTokenExpires   DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  requests                Request[]
  payments                Payment[]
  tickets                 Ticket[]
  ticketReplies           TicketReply[]
  auditLogs               AuditLog[]
  notifications           Notification[]
  fileUploads             File[]
  settings                UserSettings?
  contacts               Contact[]

  adminDisputes           PaymentDispute[]
  adminDisputeReplies     PaymentDisputeReply[]
  adminDeliverables       Deliverable[]

  @@index([email])
  @@index([role])
}

//// USER SETTINGS ////////////////////////////////////////////////

model UserSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  emailNotifications  Boolean  @default(true)
  pushNotifications   Boolean  @default(true)
  language            String   @default("en")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//// SERVICE //////////////////////////////////////////////////////

model Service {
  id                  String   @id @default(cuid())
  name                String
  slug                String   @unique
  description         String
  longDescription     String?
  idealUseCase        String?
  estimatedTurnaround String?
  price               Float    @default(0)
  pricingNote         String
  isActive            Boolean  @default(true)
  sortOrder           Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  requests Request[]

  @@index([slug])
  @@index([isActive])
}

//// REQUEST //////////////////////////////////////////////////////

model Request {
  id              String         @id @default(cuid())
  title           String
  instructions    String
  academicLevel   String
  deadline        DateTime
  notes           String?
  status           RequestStatus @default(CREATED)
  adminResponse   String?
  resolvedAt      DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  userId          String
  user            User           @relation(fields: [userId], references: [id])

  serviceId       String
  service         Service        @relation(fields: [serviceId], references: [id])

  payment         Payment?
  deliverables    Deliverable[]
  files           File[]
  tickets         Ticket[]

  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

//// PAYMENT //////////////////////////////////////////////////////

model Payment {
  id              String        @id @default(cuid())
  referenceNumber String        @unique
  amount          Float
  currency        String        @default("USD")
  receiptUrl      String
  status          PaymentStatus @default(PENDING)
  rejectionReason String?
  fraudFlagged    Boolean       @default(false)
  fraudNotes      String?
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  userId          String
  user            User          @relation(fields: [userId], references: [id])

  requestId       String        @unique
  request         Request       @relation(fields: [requestId], references: [id], onDelete: Cascade)

  dispute         PaymentDispute?

  @@index([userId])
  @@index([status])
}

//// PAYMENT DISPUTE /////////////////////////////////////////////

model PaymentDispute {
  id            String         @id @default(cuid())
  explanation   String
  adminResponse String?
  status         RequestStatus @default(CREATED)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  paymentId     String         @unique
  payment       Payment        @relation(fields: [paymentId], references: [id])

  adminId       String?
  admin         User?          @relation(fields: [adminId], references: [id])

  replies       PaymentDisputeReply[]

  @@index([status])
}

model PaymentDisputeReply {
  id          String         @id @default(cuid())
  content     String
  isAdmin     Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  disputeId   String
  dispute     PaymentDispute @relation(fields: [disputeId], references: [id])

  adminId     String?
  admin       User?          @relation(fields: [adminId], references: [id])

  @@index([createdAt])
}

//// TICKETS //////////////////////////////////////////////////////

model Ticket {
  id          String         @id @default(cuid())
  title       String
  category    String
  priority    TicketPriority @default(MEDIUM)
  status      TicketStatus   @default(OPEN)
  resolvedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  userId      String
  user        User           @relation(fields: [userId], references: [id])

  requestId   String?
  request     Request?       @relation(fields: [requestId], references: [id])

  replies     TicketReply[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model TicketReply {
  id        String   @id @default(cuid())
  content   String
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticketId  String
  ticket    Ticket  @relation(fields: [ticketId], references: [id])

  userId    String
  user      User    @relation(fields: [userId], references: [id])

  @@index([createdAt])
}

//// FILES & DELIVERABLES ////////////////////////////////////////

model Deliverable {
  id          String   @id @default(cuid())
  fileName    String
  fileUrl     String
  fileType    String
  fileSize    Int
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  requestId   String
  request     Request  @relation(fields: [requestId], references: [id])

  adminId     String?
  admin       User?    @relation(fields: [adminId], references: [id])

  @@index([requestId])
  @@index([createdAt])
}

model File {
  id        String   @id @default(cuid())
  fileName  String
  fileUrl   String
  fileType  String
  fileSize  Int
  uploadedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  requestId String?
  request   Request? @relation(fields: [requestId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

//// AUDIT & NOTIFICATIONS ///////////////////////////////////////

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entityType String
  entityId  String?
  metadata  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String?
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  userId    String
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

//// SYSTEM SETTINGS /////////////////////////////////////////////

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])
}

//// CONTACT /////////////////////////////////////////////

model Contact {
  id         String         @id @default(cuid())
  name       String
  email      String
  subject    String
  message    String
  status     ContactStatus  @default(PENDING)
  response   String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // Relations (OPTIONAL)
  adminId    String?
  admin      User?          @relation(fields: [adminId], references: [id])
}
